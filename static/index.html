<!DOCTYPE html>
<html><head>
<title>Ratio Up</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="css/bulma.min.css"/>
<link rel="stylesheet" href="css/bulma-dark.min.css"/>
<link rel="stylesheet" href="css/materialdesignicons.min.css"/>
<style>
.c1{width:5em;}
.c2{width:7em;}
.c3{width:8em;}
.vb {margin-top: auto;}
#dropoverlay {
  position: absolute;
  display: none;
  float: left;
  width: 100%; height: 100%;
  left:0; top: 0; z-index: 80;
  overflow: hidden;
  border: 5px dashed darkorange;
}

</style>
</head><body><div id="dropoverlay"></div>
<div>
  <table class="table is-striped is-hoverable is-fullwidth"><thead><tr>
    <th class="vb"><i class="mdi mdi-label"></i> Title</th>
    <th class="c2 vb"><i class="mdi mdi-harddisk"></i> Size</th>
    <th class="c3" title="Current upload speed">
      <i class="mdi mdi-upload-network" title="Overall upload speed"></i> <strong id="Overall upload speed">123 kB/s</strong>
      <div style="font-size: small; text-align: center; font-weight: normal;"><i id="min_upload">0 KB</i> - <i id="max_upload">1 KB</i></div>
    </th>
    <th class="vb c1" title="Seeders">
      <i class="mdi mdi-cloud-upload"></i>
    </th>
    <th class="vb c1" title="Leechers"><i class="mdi mdi-cloud-download"></i></th>
    <th class="c3"><div style="font-size: small; text-align: center; font-weight: normal;"><i id="client" title="Client software"></i></div><i class="mdi mdi-update"></i> Refresh in</th>
    <th class="c1 has-text-centered"><a class="has-text-success" href="javascript:start_stop()" title="Start/stop the service"  id="server-status"><i class="mdi mdi-play-circle mdi-24px"></i></a></th>
  </tr></thead><tbody id="content">
    <tr>
      <td><a href="javascript:torrent('HASH')"><i class="mdi mdi-file"></i> Ubuntu</a></td><td align="right">1.6 GB</td><!--or mdi-folder if torrent with multiple files-->
      <td align="right">864.2 KB/s</td>
      <td>64</td><td>8 <i class="is-pulled-right mdi mdi-alert has-text-warning" title="Seed is disabled when there are no leecher"></i></td>
      <td></td>
      <td><a href="javascript:toggle('HASH')" class="has-text-success"><i class="mdi mdi-toggle-switch"></i></a>
          <!--<a href="javascript:retracker('HASH')" class="has-text-warning"><i class="mdi mdi-directions-fork"></i></a>-->
          <a href="javascript:remove('HASH')" class="has-text-danger"><i class="mdi mdi-delete-forever"></i></a></td>
    </tr>
  </tbody></table>

  <i class="mdi mdi-file-multiple" title="File count"></i>mdi-folder-multiple mdi-folder mdi-folder-open
  mdi-grid (chunks)
  mdi-information
  <div style="font-size: small; text-align: center;"><a href="https://github.com/slundi/RatioUp" target="_blank"><i class="mdi mdi-github"></i> RatioUp on GitHub</a></div>
</div>
<script>
var socket=new WebSocket((window.location.protocol.toLowerCase()=='http'?'ws://':'ws://')+window.location.host+'/ws/');
socket.binaryType = 'arraybuffer';
socket.onerror=function(error) {console.log('WebSocket Error: '+error);};
socket.onopen=function(event) {console.log('Connected to: '+event.currentTarget.url);};
// Handle messages sent by the server.
socket.onmessage = function(e) {
  console.log(e);
  console.log("Message: "+e.data);
  let msg = (e.data!=null)?JSON.parse(e.data):'';
  if (e.data.startsWith('{"config":')) {
    console.log("CONFIG");
    console.log(msg['config']);
    document.getElementById("client").innerText=msg['config']['client'];
    document.getElementById("min_upload").innerText=bytes_to_Size(msg['config']['min_upload_rate']);
    document.getElementById("max_upload").innerText=bytes_to_Size(msg['config']['max_upload_rate']);
    var s=document.getElementById("toggle_seed_0_leecher");
    if(s.classList.contains("mdi-toggle-switch-off") && String(msg['config']['seed_if_zero_leecher'])=="true") {
      s.classList.remove("mdi-toggle-switch-off");
      s.classList.add("mdi-toggle-switch");
    } else if(s.classList.contains("mdi-toggle-switch") && String(msg['config']['seed_if_zero_leecher'])=="false") {
      s.classList.remove("mdi-toggle-switch");
      s.classList.add("mdi-toggle-switch-off");
    }
  }
}
socket.onclose = function(event) {console.log('Disconnected from WebSocket.');};
function start_stop() {socket.send("toggle_start");}
function update() {socket.send("update");}
function change_client(c) {socket.send("{\"client\":\""+c+"\"}");}
function toggle_seed_0_leecher() {socket.send("toggle_0_leecher");}
function set_min_upload_speed(speed) {socket.send("{\"min_upload_speed\":"+speed+"}");}
function set_max_upload_speed(speed) {socket.send("{\"max_upload_speed\":"+speed+"}");}
function toggle(h) {socket.send("{\"switch\":\""+h+"\"}");}
function remove(h) {socket.send("{\"remove\":\""+h+"\"}");}
function retracker(h, trackers) {socket.send("{\"retracker\":\""+h+"\",\"trackers\":\""+trackers+"\"}");}
window.onbeforeunload=function() {
  socket.onclose=function(){};
  socket.close();
};
function bytes_to_Size(bytes){
  if(bytes==0)return '0 B';
  var i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)));
  return Math.round(bytes/Math.pow(1024, i), 2)+' '+['B', 'KB', 'MB', 'GB', 'TB'][i];
}
['dragenter', 'dragover'].forEach(event_name=>
document.addEventListener(event_name, function(e){e.preventDefault();document.getElementById("dropoverlay").style.display="block";}, false));
['dragleave', 'drop'].forEach(event_name=>
document.addEventListener(event_name,function(e){
  e.preventDefault();
  document.getElementById("dropoverlay").style.display="none";
  let files = e.dataTransfer.files;
  console.log(files);
  let size=0;
  for(let i=0;i<files.length; i++) {if(files[i]['name'].endsWith('.torrent')) size+=files[i]['size'];}
  var reader = new FileReader();
  for(let i=0;i<files.length; i++) {if(files[i]['name'].endsWith('.torrent')) {
    reader.onload = function(e) {
      socket.send("{\"upload_size\":"+e.target.result.byteLength+",hash:\""+"\"}");
      for(let s=0; s<e.target.result.byteLength; s+=32768) socket.send(e.target.result.slice(s,s+Math.min(32768, e.target.result.byteLength-s)));
      socket.send("upload_end");
      //socket.send(e.target.result);
    };
    reader.readAsArrayBuffer(files[i]);
  }}
  }, false));
</script>
<script src="js/sha1.js" async></script>
</body>
</html>