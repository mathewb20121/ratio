<!DOCTYPE html>
<html><head>
<title>Ratio Up</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="css/bulma.min.css"/>
<link rel="stylesheet" href="css/bulma-dark.min.css"/>
<link rel="stylesheet" href="css/materialdesignicons.min.css"/>
<style>
.c1{width:5em;}
.c2{width:7em;}
.c3{width:8em;}
.vb {margin-top: auto;}
#dropoverlay {
  position: absolute;
  display: none;
  float: left;
  width: 100%; height: 100%;
  left:0; top: 0; z-index: 80;
  overflow: hidden;
  border: 5px dashed darkorange;
}
</style>
</head><body><div id="dropoverlay"></div>
<div>
  <table class="table is-striped is-hoverable is-fullwidth"><thead><tr>
    <th class="vb">
      <div class="file is-right is-small is-dark" id="upload_torrent">
        <label class="file-label">
          <input class="file-input" type="file" name="resume" accept=".torrent" multiple />
          <span class="file-cta">
            <span class="file-icon"><i class="mdi mdi-file-multiple"></i></span>
            <span class="file-label">Choose a torrent fileâ€¦</span>
          </span>
        </label>
      </div>
      <i class="mdi mdi-label"></i> Title
    </th>
    <th class="c2 vb"><br/><i class="mdi mdi-harddisk"></i> Size</th>
    <th class="c3" title="Current upload speed">
      <i class="mdi mdi-upload-network" title="Overall upload speed"></i> <strong id="Overall upload speed">123 kB/s</strong>
      <div style="font-size: small; text-align: center; font-weight: normal;"><i id="min_upload">0 KB</i> - <i id="max_upload">1 KB</i></div>
    </th>
    <th class="vb c1" title="Seeders"><br/><i class="mdi mdi-cloud-upload"></i></th>
    <th class="vb c1" title="Leechers"><br/><i class="mdi mdi-cloud-download"></i></th>
    <th class="c3"><div style="font-size: small; text-align: center; font-weight: normal;"><i id="client" title="Client software"></i></div><i class="mdi mdi-update"></i> Refresh in</th>
    <th class="c2 has-text-centered"><a href="javascript:start_stop()" title="Start/stop the service"><i class="mdi mdi-play-circle mdi-24px has-text-success" id="server-status"></i></a></th>
  </tr></thead><tbody id="content">
  </tbody></table>
  <div class="modal" id="retracker"><div class="modal-background"></div>
    <div class="modal-content">
      <h5>Retracker</h5>
      <input type="hidden" id="old-trackers" value="" />
      <div class="field is-horizontal">
        <div class="field-label is-normal"><label class="label">Tracker</label></div>
        <div class="field-body"><div class="field"><div class="control"><input class="input is-warning" type="text" placeholder="Tracker URL" /></div></div></div>
      </div>
      <div class="field is-horizontal">
        <div class="field-label is-normal"></div>
        <div class="field-body"><div class="field">
            <div class="control"><label class="checkbox"><input type="checkbox" id="apply-all-trackers" /> Apply to all torrents with the same tracker(s)</label></div>
          </div></div>
      </div>
      <a href="javascript:apply_retracker()"><i class="mdi mdi-check">Apply</i></a>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
  </div>
  <div class="modal" id="files"><div class="modal-background"></div>
    <div class="modal-content">
      <h5>Files</h5>
      <table class="table is-striped is-narrow is-fullwidth"><thead><tr><td>Path</td><td class="c2"><i class="mdi mdi-harddisk"></i> Size</td></tr></thead><tbody id="paths"></tbody></table>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
  </div>

<!--Icons to display on the torrent file browser (future feature): mdi-folder-multiple mdi-folder mdi-folder-open mdi-grid (chunks) mdi-information-->
  <div style="font-size: small; text-align: center;"><a href="https://github.com/slundi/RatioUp" target="_blank"><i class="mdi mdi-github"></i> RatioUp on GitHub</a></div>
</div>
<script>
var torrents = [];
var seed_if_zero_leecher=false;
function start_stop() {
  let r = new XMLHttpRequest();
  r.onreadystatechange = function() {
    if (r.readyState == 4 && r.status === 200) {
      s=document.getElementById("server-status");
      s.classList.remove("mdi-play-circle", "mdi-pause-circle", "has-text-success", "has-text-danger");
      if(r.responseText === "true") {
        s.classList.add("mdi-play-circle", "has-text-success");
        bulmaToast.toast({ message: '<i class="mdi mdi-check"></i> Server started', type: 'is-success', duration: 3000, position: 'bottom-right' })
      }
      else {
        s.classList.add("mdi-pause-circle", "has-text-danger");
        bulmaToast.toast({ message: '<i class="mdi mdi-alert"></i> Server stopped', type: 'is-warning', duration: 3000, position: 'bottom-right' })
      }
    }
  }
  r.open('GET', '/toggle');
  r.send();
}
function send_command(c, h){
  let r = new XMLHttpRequest();
  r.onreadystatechange = function() {
    if (r.readyState == 4 && r.status === 200) {
      let msg = JSON.parse(r.responseText);
      if (r.responseText.startsWith('{"active":')) {
        var tr = document.getElementById(msg['active']);
        var icon = tr.getElementsByClassName("state")[0];
        icon.classList.remove('mdi-toggle-switch','mdi-toggle-switch-off');
        icon.classList.add('mdi-toggle-switch');
        var link = tr.getElementsByClassName("state-link")[0];
        link.classList.remove('has-text-success','has-text-light');
        link.classList.add('has-text-success');
      } else if (r.responseText.startsWith('{"disabled":')) {
        var tr = document.getElementById(msg['disabled']);
        var icon = tr.getElementsByClassName("state")[0];
        icon.classList.remove('mdi-toggle-switch','mdi-toggle-switch-off');
        icon.classList.add('mdi-toggle-switch-off');
        var link = tr.getElementsByClassName("state-link")[0];
        link.classList.remove('has-text-success','has-text-light');
        link.classList.add('has-text-light');
      } else if (r.responseText.startsWith('{"infos":')) {
        infos = msg['infos'];
        for(let i=0; i<infos.length; i++) {
          var tr = document.getElementById(infos[i]['info_hash']);
          tr.getElementsByClassName("uploading")[0].innerHTML = bytes_to_Size(infos[i]['upload_speed']) + "/s";
          tr.getElementsByClassName("seeders")[0].innerHTML = infos[i]['seeders'];
          tr.getElementsByClassName("leechers")[0].innerHTML = infos[i]['leechers'];
        }
      } else if (r.responseText.startsWith('{"removed":')) { document.getElementById(msg['removed']).remove(); }
    }
  }
  r.open('POST', '/command', true);
  r.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  r.send('command='+c+'&infohash='+h);
}
function toggle(h) {send_command("switch", h);}
function remove(h) {if(confirm("Do you really want to delete this torrent?\nIt will be removed from the server")) send_command("remove", h);}
function retracker(h, trackers) {
  var e=document.getElementById('retracker');
  e.classList.add('is-active');
  //TODO: socket.send("{\"retracker\":\""+h+"\",\"trackers\":\""+trackers+"\"}");
}
function bytes_to_Size(bytes){
  if(bytes==0)return '0 B';
  var i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)));
  return Math.round(bytes/Math.pow(1024, i), 2)+' '+['B', 'KB', 'MB', 'GB', 'TB'][i];
}
['dragenter', 'dragover'].forEach(event_name=>
document.addEventListener(event_name, function(e){e.preventDefault();document.getElementById("dropoverlay").style.display="block";}, false));
['dragleave', 'drop'].forEach(event_name=>
document.addEventListener(event_name,function(e){
  e.preventDefault();
  document.getElementById("dropoverlay").style.display="none";
  let files = e.dataTransfer.files;
  console.log(files);
  let size=0;
  for(let i=0;i<files.length; i++) {if(files[i]['name'].endsWith('.torrent')) size+=files[i]['size'];}
  var reader = new FileReader();
  for(let i=0;i<files.length; i++) {if(files[i]['name'].endsWith('.torrent')) {
    reader.onload = function(e) {
      socket.send("{\"upload_size\":"+e.target.result.byteLength+",hash:\""+"\"}");
      for(let s=0; s<e.target.result.byteLength; s+=32768) socket.send(e.target.result.slice(s,s+Math.min(32768, e.target.result.byteLength-s)));
      socket.send("upload_end");
      //socket.send(e.target.result);
    };
    reader.readAsArrayBuffer(files[i]);
  }}
  }, false));
//upload torrent files
const fi = document.querySelector('#upload_torrent input[type=file]');
fi.onchange = () => {
  /*if (fi.files.length > 0) {
    const fileName = document.querySelector('#upload_torrent .file-name');
    //fileName.textContent = fi.files[0].name;
    console.log("TODO: upload torrent");
  }*/
  for(let i=0; i < fi.files.length; i++) {
    console.log(fi.files[i].name);
    upload_file(fi.files[i], "add_torrents", bulmaToast.toast({ message: '<i class="mdi mdi-check"></i> Torrent file uploaded', type: 'is-success', duration: 3000, position: 'bottom-right' }));
  }
}
function upload_file(file, url, success, progress){
	const ajax = new XMLHttpRequest();
	const data = new FormData();
	data.append('file', file);

	if (typeof progress=='function') {
		ajax.upload.addEventListener(
			'progress',
			function ProgressHandler(event){
				const p = Math.floor((event.loaded / event.total) * 100);
				progress(`${p}%`);
			}
		);
	}
	if (success) ajax.addEventListener('load', success, false);
	ajax.open('POST', url, true);
	ajax.send(data);
}
document.addEventListener('DOMContentLoaded', () => {
  function closeModal($el) {$el.classList.remove('is-active');}
  function closeAllModals() {(document.querySelectorAll('.modal') || []).forEach(($modal) => {closeModal($modal);});}
  // Add a click event on various child elements to close the parent modal
  (document.querySelectorAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button') || []).forEach(($close) => {
    const $target = $close.closest('.modal');
    $close.addEventListener('click', () => {closeModal($target);});
  });
  // Add a keyboard event to close all modals
  document.addEventListener('keydown', (event) => {
    const e = event || window.event;
    if (e.keyCode === 27) {closeAllModals();}// Escape key
  });
  //load config
  let rc = new XMLHttpRequest();
  rc.onreadystatechange = function() {
    if (rc.readyState == 4 && rc.status === 200) {
      let msg = JSON.parse(rc.responseText);
      document.getElementById("client").innerText=msg['config']['client'];
      document.getElementById("min_upload").innerText=bytes_to_Size(msg['config']['min_upload_rate']);
      document.getElementById("max_upload").innerText=bytes_to_Size(msg['config']['max_upload_rate']);
      let s=document.getElementById("toggle_seed_0_leecher");
      seed_if_zero_leecher=String(msg['config']['seed_if_zero_leecher'])=="true";
    }
  }
  rc.open('GET', '/config');
  rc.send();
  setInterval(load_torrents, 5000);
});
function load_torrents(){
  let r = new XMLHttpRequest();
  r.onreadystatechange = function() {
    if (r.readyState == 4 && r.status === 200) {
      let msg = JSON.parse(r.responseText);
      tbody = document.getElementById("content");
      tbody.innerHTML = "";
      torrents = msg['torrents'].sort(function(t1, t2) { //sort torrents by name
        if(t1['name'].toLowerCase() < t2['name'].toLowerCase()) return -1;
        if(t1['name'].toLowerCase() > t2['name'].toLowerCase()) return 1;
      });
      for(let i=0; i<torrents.length; i++) {
        //console.log(torrents[i]);
        tr=document.createElement('tr');
        tr.setAttribute('id', torrents[i]['info_hash']);
        tr.innerHTML = '<td>' +(torrents[i]['files']==null?'<i class="mdi mdi-file"></i> ':'<a href="javascript:files(\''+torrents[i]['info_hash']+'\')"><i class="mdi mdi-file-multiple"></i></a> ') +torrents[i]['name']+ '</td><td class="has-text-right">' +bytes_to_Size(torrents[i]['length'])+ '</td>'
                    + '<td class="has-text-right uploading">'+bytes_to_Size(torrents[i]['next_upload_speed'])+'/s</td>'
                    + '<td class="has-text-right seeders">'+torrents[i]['seeders']+'</td>'
                    + '<td class="has-text-right leechers">'+torrents[i]['leechers']+'</td>'
                    + '<td class="has-text-centered"></td>'
                    + '<td><a href="javascript:toggle(\''+torrents[i]['info_hash']+'\')" class="state-link has-text-'+(torrents[i]['active']?'success':'light')+'"><i class="mdi mdi-toggle-switch'+(torrents[i]['active']?'':'-off')+' state"></i></a> '
                        + '<!--<a href="javascript:retracker(\''+torrents[i]['info_hash']+'\')" class="has-text-warning"><i class="mdi mdi-directions-fork"></i></a> -->'
                        + '<a href="javascript:remove(\''+torrents[i]['info_hash']+'\')" class="has-text-danger"><i class="mdi mdi-delete-forever"></i></a></td>';
        tbody.append(tr);
      }
    }
  }
  r.open('GET', '/torrents');
  r.send();
}
function files(hash){
  for(let i=0; i<torrents.length; i++){
    if(torrents[i]['info_hash']==hash){
      let e=document.getElementById('files');
      e.classList.add('is-active');
      let table=document.getElementById('paths');
      for(let j=0; j<torrents[i]['files'].length; j++){
        tr=document.createElement('tr');
        tr.innerHTML='<tr><td>'+torrents[i]['files'][j]['path'].join('/')+'</td><td  class="has-text-right">'+bytes_to_Size(torrents[i]['files'][j]['length'])+'</td></tr>';
        table.append(tr);
      }
      break;
    }
  }
}
</script>
<script src="js/bulma-toast.min.js" async></script>
</body>
</html>